<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEMPMAIL - Temporary Email</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Space Grotesk', 'sans-serif'],
            },
            keyframes: {
              progressBar: {
                '0%': { width: '0%' },
                '100%': { width: '100%' },
              },
              toastIn: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              },
              toastOut: {
                '0%': { opacity: '1', transform: 'translateY(0)' },
                '100%': { opacity: '0', transform: 'translateY(20px)' },
              }
            },
            animation: {
              progressBar: 'progressBar 2s ease-out forwards',
              toastIn: 'toastIn 0.3s ease-out forwards',
              toastOut: 'toastOut 0.3s ease-in forwards',
            }
          }
        }
      }
    </script>
    
    <style type="text/css">
      /* Base Styles */
      body {
        font-family: 'Space Grotesk', sans-serif;
      }
      .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        font-size: 24px;
        vertical-align: middle;
        line-height: 1;
      }
      /* Custom scrollbar utility */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      /* Email body styling */
      #email-body-content pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 antialiased overflow-hidden">

    <div id="splash-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 transition-opacity duration-300">
        <div class="flex items-center space-x-2">
            <span class="material-symbols-outlined text-4xl text-blue-600">shield_lock</span>
            <h1 class="text-4xl font-bold">TEMPMAIL</h1>
        </div>
        <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">No Login, No Signup, Just Privacy.</p>
        <div class="w-4/5 max-w-xs h-2 bg-gray-300 dark:bg-gray-700 rounded-full overflow-hidden mt-8">
            <div id="loading-bar" class="h-2 bg-blue-600 rounded-full"></div>
        </div>
    </div>

    <div id="app-container" class="h-screen w-screen max-w-md mx-auto flex flex-col bg-white dark:bg-gray-950 shadow-2xl overflow-hidden opacity-0 transition-opacity duration-300">

        <div id="home-screen" class="flex flex-col h-full">
            <header class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-800">
                <h1 class="text-xl font-bold text-center flex-1 ml-12">TEMPMAIL</h1>
                <button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                    <span class="material-symbols-outlined" id="theme-icon">light_mode</span>
                </button>
            </header>

            <main class="flex-grow p-4 space-y-4 overflow-y-auto no-scrollbar">
                <div class="grid grid-cols-2 gap-3">
                    <button id="change-mail-btn" class="flex items-center justify-center w-full px-4 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 font-medium">
                        <svg class="spinner hidden animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span class="material-symbols-outlined mr-2 !text-xl btn-icon">change_circle</span>
                        <span class="btn-text">Change Mail</span>
                    </button>
                    <button id="delete-mail-btn" class="flex items-center justify-center w-full px-4 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 font-medium">
                        <svg class="spinner hidden animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span class="material-symbols-outlined mr-2 !text-xl btn-icon">delete_forever</span>
                        <span class="btn-text">Delete Mail</span>
                    </button>
                </div>

                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-inner">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Your temporary email address:</p>
                    <div class="flex items-center justify-between mt-2 space-x-2">
                        <span id="email-display" class="font-mono text-base font-medium break-all select-all">generating...</span>
                        <button id="copy-btn" class="flex-shrink-0 p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                            <span class="material-symbols-outlined !text-xl">content_copy</span>
                        </button>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Time Left:</p>
                        <p id="timer-display" class="text-3xl font-bold">10:00</p>
                    </div>
                    <button id="extend-btn" class="px-4 py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                        Extend
                    </button>
                </div>

                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Inbox</h2>
                        <button id="refresh-btn" class="flex items-center p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400">
                            <svg class="spinner hidden animate-spin h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span class="material-symbols-outlined !text-xl btn-icon">refresh</span>
                            <span class="btn-text ml-1 text-sm font-medium">Refresh</span>
                        </button>
                    </div>
                    
                    <div id="inbox-empty" class="text-center py-10 px-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <span class="material-symbols-outlined text-6xl text-gray-400 dark:text-gray-500">inbox</span>
                        <p class="mt-4 font-medium text-gray-700 dark:text-gray-300">Your inbox is empty</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Waiting for incoming emails...</p>
                    </div>

                    <div id="inbox-list" class="space-y-3 hidden">
                        </div>
                </div>
            </main>
        </div>

        <div id="details-screen" class="hidden flex-col h-full">
            <header class="flex-shrink-0 flex items-center p-4 border-b border-gray-200 dark:border-gray-800">
                <button id="back-btn" class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h2 class="text-lg font-semibold ml-4 truncate">Message Details</h2>
            </header>
            
            <div class="flex-grow p-4 overflow-y-auto no-scrollbar space-y-4">
                <h1 id="email-subject" class="text-2xl font-bold">Loading subject...</h1>
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-medium text-lg" id="email-avatar">
                        ?
                    </div>
                    <div>
                        <p id="email-from" class="font-medium">Loading sender...</p>
                        <p id="email-time" class="text-sm text-gray-500 dark:text-gray-400">Loading time...</p>
                    </div>
                </div>

                <hr class="border-gray-200 dark:border-gray-800">

                <div id="email-body-content" class="prose dark:prose-invert max-w-none text-gray-800 dark:text-gray-200">
                    <div class="text-center py-8">
                        <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="mt-2 text-sm text-gray-500">Loading message body...</p>
                    </div>
                </div>
            </div>

            <footer class="flex-shrink-0 p-4 border-t border-gray-200 dark:border-gray-800">
                <button id="delete-message-btn" class="w-full flex items-center justify-center px-4 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors font-medium">
                    <span class="material-symbols-outlined mr-2 !text-xl">delete</span>
                    Delete Message
                </button>
            </footer>
        </div>

    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 max-w-sm w-11/12 p-4 rounded-lg shadow-lg text-white font-medium text-center z-50 hidden">
        <span id="toast-message">Notification</span>
    </div>


    <script type="module">
        // === Global State ===
        let currentAccount = {
            id: null,
            address: null,
            token: null,
            password: null,
        };
        let inboxInterval = null;
        let timerInterval = null;
        let timerSeconds = 600; // 10 minutes
        let currentMessages = [];
        let toastTimeout = null;
        const API_BASE = 'https://api.mail.tm';

        // === DOM Elements ===
        const $ = document.querySelector.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        
        // Screens
        const splashScreen = $('#splash-screen');
        const loadingBar = $('#loading-bar');
        const appContainer = $('#app-container');
        const homeScreen = $('#home-screen');
        const detailsScreen = $('#details-screen');
        
        // Theme
        const themeToggleBtn = $('#theme-toggle-btn');
        const themeIcon = $('#theme-icon');
        
        // Home
        const changeMailBtn = $('#change-mail-btn');
        const deleteMailBtn = $('#delete-mail-btn');
        const emailDisplay = $('#email-display');
        const copyBtn = $('#copy-btn');
        const timerDisplay = $('#timer-display');
        const extendBtn = $('#extend-btn');
        const refreshBtn = $('#refresh-btn');
        const inboxEmpty = $('#inbox-empty');
        const inboxList = $('#inbox-list');
        
        // Details
        const backBtn = $('#back-btn');
        const emailSubject = $('#email-subject');
        const emailAvatar = $('#email-avatar');
        const emailFrom = $('#email-from');
        const emailTime = $('#email-time');
        const emailBody = $('#email-body-content');
        const deleteMessageBtn = $('#delete-message-btn');
        
        // Toast
        const toast = $('#toast');
        const toastMessage = $('#toast-message');

        // === Helper Functions ===

        /**
         * Fetches a resource with a timeout.
         * @param {string} resource - The URL to fetch.
         * @param {object} options - Fetch options.
         * @param {number} [timeout=8000] - Timeout in milliseconds.
         */
        const fetchWithTimeout = async (resource, options = {}, timeout = 8000) => {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(resource, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out');
                }
                throw error;
            }
        };
        
        /**
         * Displays an animated toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'warn'} [type='success'] - The toast type.
         */
        const showToast = (message, type = 'success') => {
            if (toastTimeout) {
                clearTimeout(toastTimeout);
                toast.removeEventListener('animationend', hideToast);
            }
            
            toastMessage.textContent = message;
            toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 max-w-sm w-11/12 p-4 rounded-lg shadow-lg text-white font-medium text-center z-50'; // Reset
            
            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else if (type === 'warn') {
                toast.classList.add('bg-yellow-600');
            } else {
                toast.classList.add('bg-gray-800');
            }

            toast.classList.remove('hidden', 'animate-toastOut');
            toast.classList.add('animate-toastIn');
            
            toastTimeout = setTimeout(() => {
                toast.classList.remove('animate-toastIn');
                toast.classList.add('animate-toastOut');
                toast.addEventListener('animationend', hideToast, { once: true });
            }, 3000);
        };

        const hideToast = () => {
            toast.classList.add('hidden');
            toast.classList.remove('animate-toastOut');
        };

        /**
         * Toggles loading spinner on a button.
         * @param {HTMLElement} button - The button element.
         * @param {boolean} [show=true] - Whether to show or hide the spinner.
         */
        const showSpinner = (button, show = true) => {
            const spinner = button.querySelector('.spinner');
            const icon = button.querySelector('.btn-icon');
            const text = button.querySelector('.btn-text');
            
            if (spinner) spinner.classList.toggle('hidden', !show);
            if (icon) icon.classList.toggle('hidden', show);
            if (text) text.classList.toggle('hidden', show);
            
            button.disabled = show;
        };
        
        /**
         * Escapes HTML special characters in a string.
         * @param {string} str - The string to escape.
         */
        const escapeHTML = (str) => {
            if (!str) return '';
            return str.replace(/[&<>"']/g, (match) => {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
                return map[match];
            });
        };

        /**
         * Formats a date string into a relative time.
         * @param {string} dateString - The ISO date string.
         */
        const formatDate = (dateString) => {
            const date = new Date(dateString);
            const now = new Date();
            const diff = Math.round((now - date) / 1000); // seconds
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };
        
        // === Core App Logic ===

        /**
         * Initializes the application, handles splash screen, and fetches first email.
         */
        const initApp = () => {
            console.log("Initializing App...");
            initTheme();
            setupEventListeners();
            
            // Handle splash screen
            loadingBar.addEventListener('animationend', () => {
                setTimeout(() => {
                    splashScreen.classList.add('opacity-0');
                    appContainer.classList.remove('opacity-0');
                    
                    splashScreen.addEventListener('transitionend', () => {
                        splashScreen.classList.add('hidden');
                        getNewEmail(false, true); // Get first email
                    }, { once: true });
                }, 500); // Wait 500ms after bar fills
            });
            
            // Start loading bar animation
            loadingBar.classList.add('animate-progressBar');
        };

        /**
         * Sets up dark/light mode based on localStorage.
         */
        const initTheme = () => {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                themeIcon.textContent = 'dark_mode';
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.textContent = 'light_mode';
            }
        };

        /**
         * Toggles dark/light mode.
         */
        const toggleTheme = () => {
            if (document.documentElement.classList.toggle('dark')) {
                localStorage.theme = 'dark';
                themeIcon.textContent = 'dark_mode';
            } else {
                localStorage.theme = 'light';
                themeIcon.textContent = 'light_mode';
            }
        };

        /**
         * Starts the 10-minute countdown timer.
         */
        const startTimer = () => {
            clearInterval(timerInterval);
            timerSeconds = 600;
            
            const updateDisplay = () => {
                const mins = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
                const secs = (timerSeconds % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${mins}:${secs}`;
            };
            
            updateDisplay();
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateDisplay();
                
                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    showToast("Timer expired! Extend or get new email.", "warn");
                }
            }, 1000);
        };
        
        /**
         * Resets the timer to 10 minutes.
         */
        const extendTimer = () => {
            startTimer();
            showToast("Timer reset to 10 minutes!");
        };

        /**
         * Fetches a new temporary email account.
         * @param {boolean} [isDelete=false] - Whether to delete the old account first.
         * @param {boolean} [isInit=false] - Whether this is the initial load.
         */
        const getNewEmail = async (isDelete = false, isInit = false) => {
            const btn = isDelete ? deleteMailBtn : changeMailBtn;
            if (!isInit) showSpinner(btn, true);
            
            // Clear old state
            clearInterval(inboxInterval);
            clearInterval(timerInterval);
            currentMessages = [];
            renderInbox([]);
            if (!isInit) emailDisplay.textContent = 'generating...';

            try {
                // Step 0: Delete old account if requested
                if (isDelete && currentAccount.id && currentAccount.token) {
                    try {
                        await fetchWithTimeout(`${API_BASE}/accounts/${currentAccount.id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${currentAccount.token}` }
                        });
                    } catch (delError) {
                        console.warn("Failed to delete old account, proceeding anyway.", delError);
                    }
                }
                
                // Step 1: Get available domain
                const domainRes = await fetchWithTimeout(`${API_BASE}/domains`);
                if (!domainRes.ok) throw new Error('Failed to fetch domains');
                const domains = await domainRes.json();
                const domain = domains['hydra:member'][0].domain;
                
                // Step 2: Create account
                const username = 'temp' + Date.now().toString().slice(-6) + Math.random().toString(36).substring(2, 6);
                const password = Math.random().toString(36).substring(2, 12) + 'A!';
                const address = `${username}@${domain}`;
                
                const accRes = await fetchWithTimeout(`${API_BASE}/accounts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });
                if (!accRes.ok) {
                    const errorData = await accRes.json();
                    console.error("Account creation error:", errorData);
                    throw new Error(`Failed to create account: ${errorData['hydra:description'] || accRes.statusText}`);
                }
                const accountData = await accRes.json();
                
                // Step 3: Get token
                const tokenRes = await fetchWithTimeout(`${API_BASE}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, password })
                });
                if (!tokenRes.ok) throw new Error('Failed to get auth token');
                const tokenData = await tokenRes.json();
                
                // Step 4: Update state
                currentAccount = {
                    id: accountData.id,
                    address: accountData.address,
                    token: tokenData.token,
                    password: password
                };
                
                // Step 5: Update UI and restart timers/polling
                emailDisplay.textContent = currentAccount.address;
                startTimer();
                checkInbox(); // Check once immediately
                inboxInterval = setInterval(checkInbox, 10000); // Poll every 10s
                
                const toastMsg = isDelete ? "Account deleted, new email ready!" : "New email generated!";
                if (!isInit) showToast(toastMsg);
                
            } catch (error) {
                console.error('Error in getNewEmail:', error);
                showToast(`Error: ${error.message}`, 'error');
                if (!isInit) emailDisplay.textContent = 'Error!';
            } finally {
                if (!isInit) showSpinner(btn, false);
            }
        };

        /**
         * Checks the inbox for new messages.
         */
        const checkInbox = async () => {
            if (!currentAccount.token) return;
            
            showSpinner(refreshBtn, true);
            
            try {
                const res = await fetchWithTimeout(`${API_BASE}/messages`, {
                    headers: { 'Authorization': `Bearer ${currentAccount.token}` }
                });
                
                if (res.status === 401) {
                    // Token expired
                    clearInterval(inboxInterval);
                    showToast("Session expired. Getting a new email...", "warn");
                    getNewEmail(false);
                    return;
                }
                
                if (!res.ok) throw new Error('Failed to fetch inbox');
                
                const data = await res.json();
                const newMessages = data['hydra:member'];
                
                // Check if inbox has changed
                if (newMessages.length !== currentMessages.length) {
                    currentMessages = newMessages;
                    renderInbox(currentMessages);
                    if (newMessages.length > 0 && !document.hidden) {
                        // Don't show toast on first check or if it's just a refresh
                    }
                }
            } catch (error) {
                console.error("Error checking inbox:", error);
                // Don't show toast on routine checks unless it's a major failure
            } finally {
                showSpinner(refreshBtn, false);
            }
        };

        /**
         * Renders the message list in the inbox.
         * @param {Array} messages - List of message objects.
         */
        const renderInbox = (messages) => {
            if (messages.length === 0) {
                inboxEmpty.classList.remove('hidden');
                inboxList.classList.add('hidden');
                inboxList.innerHTML = '';
            } else {
                inboxEmpty.classList.add('hidden');
                inboxList.classList.remove('hidden');
                
                messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                inboxList.innerHTML = messages.map(msg => `
                    <div class="message-item p-4 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-sm hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer transition-colors" data-id="${msg.id}">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-blue-600 dark:text-blue-400 truncate">${escapeHTML(msg.from.name || msg.from.address)}</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0 ml-2">${formatDate(msg.createdAt)}</span>
                        </div>
                        <p class="font-semibold truncate mt-1">${escapeHTML(msg.subject)}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate mt-1">${escapeHTML(msg.intro)}</p>
                    </div>
                `).join('');
                
                // Add click listeners to new items
                inboxList.querySelectorAll('.message-item').forEach(item => {
                    item.addEventListener('click', () => openEmail(item.dataset.id));
                });
            }
        };

        /**
         * Fetches and displays a single email message.
         * @param {string} id - The message ID.
         */
        const openEmail = async (id) => {
            // Show details screen
            homeScreen.classList.add('hidden');
            detailsScreen.classList.remove('hidden');
            
            // Reset view
            emailSubject.textContent = 'Loading subject...';
            emailFrom.textContent = 'Loading sender...';
            emailTime.textContent = '';
            emailAvatar.textContent = '?';
            emailBody.innerHTML = `
                <div class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-2 text-sm text-gray-500">Loading message body...</p>
                </div>`;
            
            try {
                const res = await fetchWithTimeout(`${API_BASE}/messages/${id}`, {
                    headers: { 'Authorization': `Bearer ${currentAccount.token}` }
                });
                
                if (res.status === 401) {
                    showToast("Session expired. Getting new email...", "warn");
                    goBackHome();
                    getNewEmail(false);
                    return;
                }
                
                if (!res.ok) throw new Error('Failed to fetch message');
                
                const data = await res.json();
                
                emailSubject.textContent = data.subject || '(No Subject)';
                const fromName = data.from.name || data.from.address;
                emailFrom.textContent = fromName;
                emailTime.textContent = formatDate(data.createdAt);
                emailAvatar.textContent = (fromName[0] || '?').toUpperCase();
                
                // Render body
                emailBody.innerHTML = ''; // Clear spinner
                const bodyContent = data.html && data.html.length > 0 ? data.html[0] : null;
                
                if (bodyContent) {
                    // Use iframe with srcdoc to render HTML safely in a sandbox
                    const iframe = document.createElement('iframe');
                    iframe.setAttribute('srcdoc', `
                        <html>
                        <head>
                          <style>
                            body { 
                              font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
                              line-height: 1.6; 
                              padding: 10px;
                              margin: 0;
                              word-wrap: break-word;
                              color: ${document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#1f2937'};
                            }
                            a { color: ${document.documentElement.classList.contains('dark') ? '#60a5fa' : '#2563eb'}; }
                            img { max-width: 100%; height: auto; }
                          </style>
                        </head>
                        <body>${bodyContent}</body>
                        </html>
                    `);
                    iframe.setAttribute('sandbox', 'allow-same-origin'); // Allow styles from srcdoc, but block scripts
                    iframe.className = 'w-full h-full border-0 min-h-[50vh]';
                    emailBody.appendChild(iframe);
                    
                    // Adjust height
                    iframe.onload = () => {
                        try {
                            const bodyHeight = iframe.contentWindow.document.body.scrollHeight;
                            iframe.style.height = `${bodyHeight + 40}px`;
                        } catch(e) {
                            console.warn("Could not auto-resize iframe, using default height.");
                            iframe.style.height = '60vh';
                        }
                    };
                } else {
                    // Fallback to plain text
                    const pre = document.createElement('pre');
                    pre.textContent = data.text || '(Empty message)';
                    emailBody.appendChild(pre);
                }
                
            } catch (error) {
                console.error("Error opening email:", error);
                emailBody.innerHTML = `<p class="text-red-500">Error: Could not load message content.</p>`;
            }
        };

        /**
         * Navigates from details screen back to home.
         */
        const goBackHome = () => {
            detailsScreen.classList.add('hidden');
            homeScreen.classList.remove('hidden');
        };

        /**
         * Copies the current email address to the clipboard.
         */
        const copyToClipboard = () => {
            if (!currentAccount.address) return;
            navigator.clipboard.writeText(currentAccount.address)
                .then(() => {
                    showToast("Email address copied!");
                })
                .catch(err => {
                    console.error("Failed to copy:", err);
                    showToast("Failed to copy.", "error");
                });
        };
        
        /**
         * Sets up all initial event listeners.
         */
        const setupEventListeners = () => {
            themeToggleBtn.addEventListener('click', toggleTheme);
            copyBtn.addEventListener('click', copyToClipboard);
            changeMailBtn.addEventListener('click', () => getNewEmail(false));
            deleteMailBtn.addEventListener('click', () => getNewEmail(true));
            extendBtn.addEventListener('click', extendTimer);
            refreshBtn.addEventListener('click', checkInbox);
            backBtn.addEventListener('click', goBackHome);
            
            deleteMessageBtn.addEventListener('click', () => {
                // This is simulated as requested
                showToast("Message deleted (locally).", "warn");
                goBackHome();
                // In a real app, you'd also filter this from `currentMessages`
                // and call a DELETE API if it existed.
            });
        };

        // === App Entry Point ===
        document.addEventListener('DOMContentLoaded', initApp);
        
    </script>
</body>
</html>
